# 测试策略

## 1. 概述

本文档描述了中文学习平台的测试策略，包括单元测试、集成测试、端到端测试、性能测试、错误处理测试和安全性测试。

## 2. 测试类型

### 2.1 单元测试

#### 目的

*   验证每个模块（例如模型、服务、工具函数）的功能是否正确。
*   确保每个模块的逻辑正确性，覆盖正常情况、边界情况和异常情况。
*   提供快速反馈，方便开发人员及时发现和修复问题。

#### 方法

*   使用 `pytest` 测试框架来组织和运行测试。
*   为每个模块编写独立的测试用例，确保测试用例的独立性。
*   使用 `fixture` 或其他方法，在测试前清理测试数据。
*   使用 `assert` 语句来验证 API 的返回结果是否符合预期。
*   覆盖正常情况、边界情况和异常情况，例如：
    *   有效输入：验证 API 在有效输入下的正确性。
    *   无效输入：验证 API 在无效输入下的错误处理逻辑。
    *   边界值：验证 API 在边界值附近的表现。
    *   缺失参数：验证 API 在缺少必填参数时的错误处理。
    *   错误码：确保返回的错误码与 API 文档中的定义一致。
    *   数据类型：验证 API 对不同数据类型的处理是否正确。
    *   分页：验证 API 分页逻辑是否正确。

#### 测试范围

*   **模型层**: 测试数据模型的定义和操作，例如数据类型的验证，数据的 CRUD 操作，以及数据模型的 `characters` 字段的正确性。
*   **服务层**: 测试业务逻辑的处理，例如故事的生成、字词的查询、场景的管理，以及生字率计算逻辑的正确性。
    *  **自定义分词**: 确保自定义分词的逻辑正确，并且能够正确处理各种情况，例如：
         *   文本中包含词汇表中的词语。
         *   文本中不包含词汇表中的词语。
        *    文本中包含多个词汇表中的词语。
       *  验证  `_load_known_words`  函数是否正确加载了已知词汇和词性。
       *   验证  `_calculate_literacy_rate` 函数是否正确计算了生字率。
*   **工具函数**: 测试工具函数的正确性，例如错误处理函数、API 认证函数、以及其他工具函数。
*   **提示语生成**:  验证提示语生成函数的正确性，确保生成的提示语符合预期的格式和内容。

#### 最佳实践

*   **提前规划与设计**: 在开始测试之前，务必充分理解产品需求文档 (PRD) 和 API 设计指南，明确每个 API 的功能、输入参数、输出格式和错误处理逻辑。
*   **设计测试用例**: 根据需求设计全面的测试用例，覆盖正常情况、边界情况和异常情况。
*   **自底向上测试**: 从最底层的模型层开始测试，逐步向上测试服务层和 API 路由层。
*   **重视错误信息与调试**: 确保 API 返回的错误信息清晰、具体，方便定位问题。可以使用自定义的错误码和错误信息，提供更详细的错误上下文。
*   **日志记录**: 在代码中添加日志记录，方便追踪程序运行过程中的问题。
*   **测试代码的独立性**: 每个测试用例都应该独立运行，不依赖于其他测试用例产生的数据。可以使用 fixture 或其他方法，在测试前清理测试数据。
*   **断言的准确性**: 使用断言来验证 API 的返回结果是否符合预期。确保断言的条件正确，能够准确地判断测试是否通过。
*   **测试代码的可读性**: 编写可读性高的测试代码，方便其他人理解和维护。
*   **避免重复代码**: 使用 fixture 或其他方法，避免测试代码中的重复代码。
*   **持续集成与自动化测试**: 将测试代码自动化，每次修改代码后都自动运行测试，及时发现问题。
*   **单元测试应该重点测试核心代码**:  例如生字率计算，多轮对话的逻辑，API 鉴权， 和 API 参数验证。
* **单元测试的代码覆盖率不应该低于 80%**。

### 2.2 集成测试

#### 目的

*   验证 API 接口的请求参数验证、业务逻辑处理和响应格式是否正确。
*   确保 API 能够正确地与其他模块进行交互。

#### 方法

*   使用测试客户端 (`Flask` 提供的 `test_client`) 来模拟 API 请求。
*   验证 API 的返回码、响应信息和数据是否符合预期。

#### 测试范围

*   **API 接口**: 测试 API 接口的请求参数验证、业务逻辑处理和响应格式是否正确，包括：
    *   故事生成 API： 验证请求参数，生字率计算，重点词汇，和 JSON 响应, 包括 `story_word_count` 参数。
    *   场景管理 API：验证场景的 CRUD 操作。
    *   字词查询 API：验证分页查询和参数过滤， 以及 `characters` 字段。
    *   故事升级/降级 API： 验证故事的升级和降级逻辑。
     *   **多轮对话**:  验证多轮对话的逻辑和提示语的生成。

### 2.3 端到端测试

#### 目的

*   模拟用户完整的操作流程，验证多个模块的协同工作是否正确。
*   验证数据流转和整体功能是否正常。

#### 方法

*   模拟用户完整的操作流程，例如：
    1.  用户通过 API 创建一个场景。
    2.  用户通过 API 添加一些字词。
    3.  用户通过 API 生成一个故事。
    4.  用户通过 API 查询生成的故事。
    5.  用户通过 API 升级/降级故事。
*   验证整个流程是否正确，包括数据流转、业务逻辑和用户界面（如果存在）。

### 2.4 性能测试

#### 目的

*   验证 API 的响应时间、吞吐量和稳定性是否满足要求。
*   分析性能瓶颈，并进行相应的优化。

#### 方法

*   使用性能测试工具，对 API 进行压力测试。
*   监控 API 的响应时间、吞吐量、CPU 使用率、内存使用率等指标。
*   根据测试结果，优化代码或服务器配置。

#### 测试指标

*   **API 的响应时间**:
    *   故事生成 API 的响应时间应控制在 2 秒以内。
    *   场景管理、字词查询 API 的响应时间应控制在 500 毫秒以内。
    *   故事升级/降级 API 的响应时间应控制在 1 秒以内。
*   **吞吐量**:
     *  API 的吞吐量应该能够满足用户的需求，需要进行压力测试，模拟多用户并发访问。
*   **多轮对话性能**:
    *   验证多轮对话的响应时间。

### 2.5 错误处理测试

#### 目的

*   验证 API 对各种错误情况的处理是否正确。
*   确保 API 返回的错误码和错误信息清晰、准确。

#### 方法

*   模拟各种错误情况，例如：
    *   参数错误：缺少必填字段、字段类型错误、字段值超出范围。
    *   资源不存在：场景未找到、字词未找到、故事未找到。
    *   未授权：API Key 缺失、API Key 无效。
    *   服务器内部错误：数据库连接失败、第三方服务调用失败、AI 服务调用失败。
    *   请求过多：超出请求频率限制。
    *   数据验证失败: 数据类型错误，数据格式错误。
*   验证 API 返回的错误码和错误信息是否符合预期。
*   使用 `app/utils/error_handling.py` 中提供的 `handle_error` 函数统一处理 API 的错误，确保错误码和错误信息与 API 设计指南一致。

### 2.6 安全性测试

#### 目的

*   验证 API 是否进行了身份验证，确保只有授权的用户可以访问 API。
*   验证 API 是否存在安全漏洞，例如 SQL 注入、跨站脚本攻击等。

#### 方法

*   使用安全性测试工具，模拟各种攻击场景。
*   验证 API 是否进行了身份验证。
*   验证 API 是否存在安全漏洞。

## 3. 测试策略

### 3.1 测试准备

*   **理解需求**: 在开始测试之前，务必充分理解产品需求文档 (PRD) 和 API 设计指南，明确每个 API 的功能、输入参数、输出格式和错误处理逻辑。
*   **设计测试用例**: 根据需求设计全面的测试用例，覆盖正常情况、边界情况和异常情况。

### 3.2 测试执行

*   **分层测试与逐步推进**: 从最底层的模型层开始测试，逐步向上测试服务层和 API 路由层。
*   **先单元测试，后集成测试**: 先对每个模块进行单元测试，确保其功能正常，然后再进行集成测试，验证模块之间的交互。
*   **逐步推进**: 不要试图一次性解决所有问题。先专注于解决最基本的问题，然后逐步扩展测试范围。
*   **重视错误信息与调试**: 确保 API 返回的错误信息清晰、具体，方便定位问题。可以使用自定义的错误码和错误信息，提供更详细的错误上下文。

### 3.3 测试报告

*   记录测试结果，包括测试用例的执行情况、发现的缺陷和测试覆盖率。
*   为每个测试类型编写测试报告。
*   及时反馈测试结果给开发人员。

## 4. 测试人员的建议

### 4.1 对文档编写者的建议

*   **明确性与准确性**: 避免歧义，准确描述功能，明确定义术语，统一数据格式。
*   **完整性与全面性**: 覆盖所有功能，包括所有接口，考虑各种场景，提供完整的数据模型。
*   **可测试性与可验证性**: 提供可测试的描述，提供测试数据，提供错误码和错误信息，描述边界条件，描述预期结果。
*   **实用性与易用性**: 结构清晰，提供示例代码，使用用户友好的语言，可搜索性，及时更新。
*   **针对测试人员的建议**: 提供测试策略，明确测试重点，反馈机制，协同编写。

    **本次项目中的教训：**

    *   **API 返回值不明确**: 在本次项目中，API 返回值格式不符合 API 文档，导致测试人员需要根据代码实现推断返回格式，增加了测试的难度。
    *   **错误码不详细**: 初始代码的错误码不够详细，测试人员需要根据错误信息和代码来判断错误的类型，增加了定位问题的难度。

### 4.2 对程序开发人员的建议

*   **代码质量与可读性**: 遵循代码规范，编写清晰的代码，避免重复代码，合理的命名，适当的注释。
*   **可测试性与可维护性**: 模块化设计，使用接口，依赖注入，避免全局变量，考虑测试性。
*   **错误处理与健壮性**: 优雅的错误处理，详细的错误信息，输入参数验证，边界值处理，日志记录。
*   **单元测试与代码覆盖率**: 编写单元测试，高代码覆盖率，测试边界值和异常，使用测试框架。
*   **沟通与协作**: 及时沟通，参与代码审查，及时修复缺陷，尊重测试结果。

    **本次项目中的教训：**

    *   **数据模型对象的混用**: 在本次项目中，测试人员发现代码中存在数据模型对象和字典混用的情况，导致类型错误，这需要开发人员在设计和使用数据模型的时候更加注意。
    *   **错误处理不一致**: 初始代码的错误处理不够统一，有些地方使用了 try-except 语句，有些地方没有，导致测试人员需要花费时间定位问题。
    *   **代码逻辑复杂**: 有些代码逻辑比较复杂，测试人员需要花费大量的时间阅读代码，这提示开发人员在编写代码时应该更加注重简洁易懂。

## 5. 代码规范与文档

*   **遵循代码规范**: 遵循代码规范，例如 PEP 8，确保代码的可读性。
*   **编写清晰的文档**: 编写清晰的 API 文档和用户手册，方便其他人使用 API。
*   **使用 `pytest` 作为测试框架**。